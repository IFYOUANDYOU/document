

const app = getApp()
let resdata = {
	"code": "10000",
	"msg": "OK",
	"data": {
		"score": 16,
		"markAll": 42,
		"answer": "C",
		"TopicData": [{
				"id": 13930,
				"studentId": 3307,
				"examId": 4448,
				"questionId": 12936,
				"score": 0,
				"answer": "A",
				"answerPic": "https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726286_0_423573801d88-7c70-4d4e-add5-6a28b7d1cd02/out_5046044556.jpg",
				"teacherId": null,
				"makingTime": null,
				"answerPostion": "[{\"positionY\":762.0000000000001,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4415/back/paper/13812/pages/0001_8229104760.jpg\",\"width\":2474.0000000000005,\"isRead\":1,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4415/back/paper/13812/pages/0001_8229104760.jpg?x-oss-process=image/crop,x_0,y_762,h_85,w_2474\",\"positionX\":0,\"height\":85},{\"positionY\":1524.0000000000002,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726286_0_423573801d88-7c70-4d4e-add5-6a28b7d1cd02/out_5046044556.jpg\",\"width\":2474.0000000000005,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726286_0_423573801d88-7c70-4d4e-add5-6a28b7d1cd02/out_5046044556.jpg?x-oss-process=image/crop,x_0,y_1524,h_286,w_2474\",\"positionX\":0,\"height\":286}]",
				"symbolMark": null,
				"scoreStatus": null,
				"collectStatus": null,
				"collectReason": null,
				"studentNamePic": "[{\"positionY\":638.7856125356126,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726286_0_423573801d88-7c70-4d4e-add5-6a28b7d1cd02/out_5046044556.jpg\",\"width\":402.3290598290598,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726286_0_423573801d88-7c70-4d4e-add5-6a28b7d1cd02/out_5046044556.jpg?x-oss-process=image/crop,x_1638,y_639,h_81,w_402\",\"positionX\":1637.5498575498577,\"height\":81.17165242165242}]",
				"label": null,
				"symbolPic": null
			},
			{
				"id": 13932,
				"studentId": 3306,
				"examId": 4448,
				"questionId": 12936,
				"score": 3,
				"answer": "C",
				"answerPic": "https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726380_0_42759d5ba6a7-0676-4494-a4f5-288fbf869900/out_8046300188.jpg",
				"teacherId": null,
				"makingTime": null,
				"answerPostion": "[{\"positionY\":762.0000000000001,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4415/back/paper/13812/pages/0001_8229104760.jpg\",\"width\":2474.0000000000005,\"isRead\":1,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4415/back/paper/13812/pages/0001_8229104760.jpg?x-oss-process=image/crop,x_0,y_762,h_85,w_2474\",\"positionX\":0,\"height\":85},{\"positionY\":1524.0000000000002,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726380_0_42759d5ba6a7-0676-4494-a4f5-288fbf869900/out_8046300188.jpg\",\"width\":2474.0000000000005,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726380_0_42759d5ba6a7-0676-4494-a4f5-288fbf869900/out_8046300188.jpg?x-oss-process=image/crop,x_0,y_1524,h_286,w_2474\",\"positionX\":0,\"height\":286}]",
				"symbolMark": null,
				"scoreStatus": null,
				"collectStatus": null,
				"collectReason": null,
				"studentNamePic": "[{\"positionY\":638.7856125356126,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726380_0_42759d5ba6a7-0676-4494-a4f5-288fbf869900/out_8046300188.jpg\",\"width\":402.3290598290598,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726380_0_42759d5ba6a7-0676-4494-a4f5-288fbf869900/out_8046300188.jpg?x-oss-process=image/crop,x_1638,y_639,h_81,w_402\",\"positionX\":1637.5498575498577,\"height\":81.17165242165242}]",
				"label": null,
				"symbolPic": null
			},
			{
				"id": 13934,
				"studentId": 3308,
				"examId": 4448,
				"questionId": 12936,
				"score": 0,
				"answer": "A",
				"answerPic": "https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726305_0_423605dc75be-3d04-4671-9ad7-8369cbf38c29/out_8089537120.jpg",
				"teacherId": null,
				"makingTime": null,
				"answerPostion": "[{\"positionY\":762.0000000000001,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4415/back/paper/13812/pages/0001_8229104760.jpg\",\"width\":2474.0000000000005,\"isRead\":1,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4415/back/paper/13812/pages/0001_8229104760.jpg?x-oss-process=image/crop,x_0,y_762,h_85,w_2474\",\"positionX\":0,\"height\":85},{\"positionY\":1524.0000000000002,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726305_0_423605dc75be-3d04-4671-9ad7-8369cbf38c29/out_8089537120.jpg\",\"width\":2474.0000000000005,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726305_0_423605dc75be-3d04-4671-9ad7-8369cbf38c29/out_8089537120.jpg?x-oss-process=image/crop,x_0,y_1524,h_286,w_2474\",\"positionX\":0,\"height\":286}]",
				"symbolMark": null,
				"scoreStatus": null,
				"collectStatus": null,
				"collectReason": null,
				"studentNamePic": "[{\"positionY\":638.7856125356126,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726305_0_423605dc75be-3d04-4671-9ad7-8369cbf38c29/out_8089537120.jpg\",\"width\":402.3290598290598,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726305_0_423605dc75be-3d04-4671-9ad7-8369cbf38c29/out_8089537120.jpg?x-oss-process=image/crop,x_1638,y_639,h_81,w_402\",\"positionX\":1637.5498575498577,\"height\":81.17165242165242}]",
				"label": null,
				"symbolPic": null
			},
			{
				"id": 13936,
				"studentId": 3309,
				"examId": 4448,
				"questionId": 12936,
				"score": 0,
				"answer": "A",
				"answerPic": "https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726617_0_42891ded5119-a86a-4143-a0dc-67b871c96486/out_7711858199.jpg",
				"teacherId": null,
				"makingTime": null,
				"answerPostion": "[{\"positionY\":762.0000000000001,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4415/back/paper/13812/pages/0001_8229104760.jpg\",\"width\":2474.0000000000005,\"isRead\":1,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4415/back/paper/13812/pages/0001_8229104760.jpg?x-oss-process=image/crop,x_0,y_762,h_85,w_2474\",\"positionX\":0,\"height\":85},{\"positionY\":1524.0000000000002,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726617_0_42891ded5119-a86a-4143-a0dc-67b871c96486/out_7711858199.jpg\",\"width\":2474.0000000000005,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726617_0_42891ded5119-a86a-4143-a0dc-67b871c96486/out_7711858199.jpg?x-oss-process=image/crop,x_0,y_1524,h_286,w_2474\",\"positionX\":0,\"height\":286}]",
				"symbolMark": null,
				"scoreStatus": null,
				"collectStatus": null,
				"collectReason": null,
				"studentNamePic": "[{\"positionY\":638.7856125356126,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726617_0_42891ded5119-a86a-4143-a0dc-67b871c96486/out_7711858199.jpg\",\"width\":402.3290598290598,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726617_0_42891ded5119-a86a-4143-a0dc-67b871c96486/out_7711858199.jpg?x-oss-process=image/crop,x_1638,y_639,h_81,w_402\",\"positionX\":1637.5498575498577,\"height\":81.17165242165242}]",
				"label": null,
				"symbolPic": null
			},
			{
				"id": 13937,
				"studentId": 3311,
				"examId": 4448,
				"questionId": 12936,
				"score": 3,
				"answer": "C",
				"answerPic": "https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726396_0_4276c7ef4cbc-2cd6-49ab-b143-57c55df388f5/out_3377723613.jpg",
				"teacherId": null,
				"makingTime": null,
				"answerPostion": "[{\"positionY\":762.0000000000001,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4415/back/paper/13812/pages/0001_8229104760.jpg\",\"width\":2474.0000000000005,\"isRead\":1,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4415/back/paper/13812/pages/0001_8229104760.jpg?x-oss-process=image/crop,x_0,y_762,h_85,w_2474\",\"positionX\":0,\"height\":85},{\"positionY\":1524.0000000000002,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726396_0_4276c7ef4cbc-2cd6-49ab-b143-57c55df388f5/out_3377723613.jpg\",\"width\":2474.0000000000005,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726396_0_4276c7ef4cbc-2cd6-49ab-b143-57c55df388f5/out_3377723613.jpg?x-oss-process=image/crop,x_0,y_1524,h_286,w_2474\",\"positionX\":0,\"height\":286}]",
				"symbolMark": null,
				"scoreStatus": null,
				"collectStatus": null,
				"collectReason": null,
				"studentNamePic": "[{\"positionY\":638.7856125356126,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726396_0_4276c7ef4cbc-2cd6-49ab-b143-57c55df388f5/out_3377723613.jpg\",\"width\":402.3290598290598,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726396_0_4276c7ef4cbc-2cd6-49ab-b143-57c55df388f5/out_3377723613.jpg?x-oss-process=image/crop,x_1638,y_639,h_81,w_402\",\"positionX\":1637.5498575498577,\"height\":81.17165242165242}]",
				"label": null,
				"symbolPic": null
			},
			{
				"id": 13939,
				"studentId": 3310,
				"examId": 4448,
				"questionId": 12936,
				"score": 0,
				"answer": "A",
				"answerPic": "https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726485_0_42811bc8cef4-6615-4147-b4b4-54df79ae3ce2/out_3398785275.jpg",
				"teacherId": null,
				"makingTime": null,
				"answerPostion": "[{\"positionY\":762.0000000000001,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4415/back/paper/13812/pages/0001_8229104760.jpg\",\"width\":2474.0000000000005,\"isRead\":1,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4415/back/paper/13812/pages/0001_8229104760.jpg?x-oss-process=image/crop,x_0,y_762,h_85,w_2474\",\"positionX\":0,\"height\":85},{\"positionY\":1524.0000000000002,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726485_0_42811bc8cef4-6615-4147-b4b4-54df79ae3ce2/out_3398785275.jpg\",\"width\":2474.0000000000005,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726485_0_42811bc8cef4-6615-4147-b4b4-54df79ae3ce2/out_3398785275.jpg?x-oss-process=image/crop,x_0,y_1524,h_286,w_2474\",\"positionX\":0,\"height\":286}]",
				"symbolMark": null,
				"scoreStatus": null,
				"collectStatus": null,
				"collectReason": null,
				"studentNamePic": "[{\"positionY\":638.7856125356126,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726485_0_42811bc8cef4-6615-4147-b4b4-54df79ae3ce2/out_3398785275.jpg\",\"width\":402.3290598290598,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726485_0_42811bc8cef4-6615-4147-b4b4-54df79ae3ce2/out_3398785275.jpg?x-oss-process=image/crop,x_1638,y_639,h_81,w_402\",\"positionX\":1637.5498575498577,\"height\":81.17165242165242}]",
				"label": null,
				"symbolPic": null
			},
			{
				"id": 13947,
				"studentId": 3313,
				"examId": 4448,
				"questionId": 12936,
				"score": 0,
				"answer": "A",
				"answerPic": "https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726501_0_42827775bff0-2b49-4738-921b-b8c681919277/out_6189550239.jpg",
				"teacherId": null,
				"makingTime": null,
				"answerPostion": "[{\"positionY\":762.0000000000001,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4415/back/paper/13812/pages/0001_8229104760.jpg\",\"width\":2474.0000000000005,\"isRead\":1,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4415/back/paper/13812/pages/0001_8229104760.jpg?x-oss-process=image/crop,x_0,y_762,h_85,w_2474\",\"positionX\":0,\"height\":85},{\"positionY\":1524.0000000000002,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726501_0_42827775bff0-2b49-4738-921b-b8c681919277/out_6189550239.jpg\",\"width\":2474.0000000000005,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726501_0_42827775bff0-2b49-4738-921b-b8c681919277/out_6189550239.jpg?x-oss-process=image/crop,x_0,y_1524,h_286,w_2474\",\"positionX\":0,\"height\":286}]",
				"symbolMark": null,
				"scoreStatus": null,
				"collectStatus": null,
				"collectReason": null,
				"studentNamePic": "[{\"positionY\":638.7856125356126,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726501_0_42827775bff0-2b49-4738-921b-b8c681919277/out_6189550239.jpg\",\"width\":402.3290598290598,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726501_0_42827775bff0-2b49-4738-921b-b8c681919277/out_6189550239.jpg?x-oss-process=image/crop,x_1638,y_639,h_81,w_402\",\"positionX\":1637.5498575498577,\"height\":81.17165242165242}]",
				"label": null,
				"symbolPic": null
			},
			{
				"id": 13950,
				"studentId": 3312,
				"examId": 4448,
				"questionId": 12936,
				"score": 3,
				"answer": "C",
				"answerPic": "https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726535_0_42848bd6ee5b-f81d-4c15-a3df-8563b75c4c41/out_5823779060.jpg",
				"teacherId": null,
				"makingTime": null,
				"answerPostion": "[{\"positionY\":762.0000000000001,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4415/back/paper/13812/pages/0001_8229104760.jpg\",\"width\":2474.0000000000005,\"isRead\":1,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4415/back/paper/13812/pages/0001_8229104760.jpg?x-oss-process=image/crop,x_0,y_762,h_85,w_2474\",\"positionX\":0,\"height\":85},{\"positionY\":1524.0000000000002,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726535_0_42848bd6ee5b-f81d-4c15-a3df-8563b75c4c41/out_5823779060.jpg\",\"width\":2474.0000000000005,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726535_0_42848bd6ee5b-f81d-4c15-a3df-8563b75c4c41/out_5823779060.jpg?x-oss-process=image/crop,x_0,y_1524,h_286,w_2474\",\"positionX\":0,\"height\":286}]",
				"symbolMark": null,
				"scoreStatus": null,
				"collectStatus": null,
				"collectReason": null,
				"studentNamePic": "[{\"positionY\":638.7856125356126,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726535_0_42848bd6ee5b-f81d-4c15-a3df-8563b75c4c41/out_5823779060.jpg\",\"width\":402.3290598290598,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726535_0_42848bd6ee5b-f81d-4c15-a3df-8563b75c4c41/out_5823779060.jpg?x-oss-process=image/crop,x_1638,y_639,h_81,w_402\",\"positionX\":1637.5498575498577,\"height\":81.17165242165242}]",
				"label": null,
				"symbolPic": null
			},
			{
				"id": 13953,
				"studentId": 3314,
				"examId": 4448,
				"questionId": 12936,
				"score": 0,
				"answer": "A",
				"answerPic": "https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726569_0_428664ddd4d6-e35e-40d9-8b83-d302fecc5494/out_7781928873.jpg",
				"teacherId": null,
				"makingTime": null,
				"answerPostion": "[{\"positionY\":762.0000000000001,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4415/back/paper/13812/pages/0001_8229104760.jpg\",\"width\":2474.0000000000005,\"isRead\":1,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4415/back/paper/13812/pages/0001_8229104760.jpg?x-oss-process=image/crop,x_0,y_762,h_85,w_2474\",\"positionX\":0,\"height\":85},{\"positionY\":1524.0000000000002,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726569_0_428664ddd4d6-e35e-40d9-8b83-d302fecc5494/out_7781928873.jpg\",\"width\":2474.0000000000005,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726569_0_428664ddd4d6-e35e-40d9-8b83-d302fecc5494/out_7781928873.jpg?x-oss-process=image/crop,x_0,y_1524,h_286,w_2474\",\"positionX\":0,\"height\":286}]",
				"symbolMark": null,
				"scoreStatus": null,
				"collectStatus": null,
				"collectReason": null,
				"studentNamePic": "[{\"positionY\":638.7856125356126,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726569_0_428664ddd4d6-e35e-40d9-8b83-d302fecc5494/out_7781928873.jpg\",\"width\":402.3290598290598,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726569_0_428664ddd4d6-e35e-40d9-8b83-d302fecc5494/out_7781928873.jpg?x-oss-process=image/crop,x_1638,y_639,h_81,w_402\",\"positionX\":1637.5498575498577,\"height\":81.17165242165242}]",
				"label": null,
				"symbolPic": null
			},
			{
				"id": 13956,
				"studentId": 3315,
				"examId": 4448,
				"questionId": 12936,
				"score": 0,
				"answer": "A",
				"answerPic": "https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726412_0_42771373c9f2-0b47-427a-9236-147198343754/out_3096367702.jpg",
				"teacherId": null,
				"makingTime": null,
				"answerPostion": "[{\"positionY\":762.0000000000001,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4415/back/paper/13812/pages/0001_8229104760.jpg\",\"width\":2474.0000000000005,\"isRead\":1,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4415/back/paper/13812/pages/0001_8229104760.jpg?x-oss-process=image/crop,x_0,y_762,h_85,w_2474\",\"positionX\":0,\"height\":85},{\"positionY\":1524.0000000000002,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726412_0_42771373c9f2-0b47-427a-9236-147198343754/out_3096367702.jpg\",\"width\":2474.0000000000005,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726412_0_42771373c9f2-0b47-427a-9236-147198343754/out_3096367702.jpg?x-oss-process=image/crop,x_0,y_1524,h_286,w_2474\",\"positionX\":0,\"height\":286}]",
				"symbolMark": null,
				"scoreStatus": null,
				"collectStatus": null,
				"collectReason": null,
				"studentNamePic": "[{\"positionY\":638.7856125356126,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726412_0_42771373c9f2-0b47-427a-9236-147198343754/out_3096367702.jpg\",\"width\":402.3290598290598,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4448/back//userData/ygf/workCheck/ygf_2019-07-09_1562642726412_0_42771373c9f2-0b47-427a-9236-147198343754/out_3096367702.jpg?x-oss-process=image/crop,x_1638,y_639,h_81,w_402\",\"positionX\":1637.5498575498577,\"height\":81.17165242165242}]",
				"label": null,
				"symbolPic": null
			}
		],
		"check": 42,
		"type": 1,
		"questionPic": "[{\"positionY\":762.0000000000001,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4415/back/paper/13812/pages/0001_8229104760.jpg\",\"width\":2474.0000000000005,\"isRead\":1,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4415/back/paper/13812/pages/0001_8229104760.jpg?x-oss-process=image/crop,x_0,y_762,h_85,w_2474\",\"positionX\":0,\"height\":85},{\"positionY\":1524.0000000000002,\"url1\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4415/back/paper/13812/pages/0001_8229104760.jpg\",\"width\":2474.0000000000005,\"url\":\"https://wechat-test2.oss-cn-shenzhen.aliyuncs.com/4415/back/paper/13812/pages/0001_8229104760.jpg?x-oss-process=image/crop,x_0,y_1524,h_286,w_2474\",\"positionX\":0,\"height\":286}]"
	}
}
import {
  getUnchecked,
  updateTopic,
  topicRule,
  findChecked,
  findStudentUion,
  updateRule,
  getStudentUnionExamMore,
  findAllexaminfo
} from '../../lib/api';
// pages/marking/marking.js
// 触摸开始时间
let touchStartTime = 0;
// 触摸结束时间
let touchEndTime = 0;
// 最后一次单击事件点击发生时间
let timers1;
var strat_x, end_x;
let imgobj = {};
var textArrays = [],oldText = 0,lineArrays = [],oldLine = 0;
var default_text_top = 0,default_text_left = 0;
let largeTimes = 0;


var newDist = 0;
var oldDist = 0;
var inScale = false;
var beforeWidth = 0, beforeHeight = 0;
var lastTouchPoint = { x: 0, y: 0 };
var inTouch = false;

Page({
  data: {
    distance: 0,
    scale: 1,
    marginTop: 0,
    marginLeft: 0,

    

    vw: 0,
    vh: 0,

    imgcomplete: false,
    boxTop: 0,
    boxLeft: 0,
    boxBot: 0,
    barHeight: 0,//
    page_title: '阅卷',
    

    scoreMark: {}, //分值 及  对错图标
    textMark: [], //文字标记集合
    lineMark: [], //划线集合
    chooseCode: [],//
    keyrows: 1,//横屏下打分数字的列数

    enlargeX: 260,
    enlargeY: 400, //放大坐标图标拖动控制
    isLarge: true,

    examId: 0,
    questionId: 0,
    back: false,  //false 评卷  true 回评

    totalnum: 0,//总数量
    curpage: 1,//当前页码
    allpage: 1,
    alldatas: [],//所有数据

    current: -1, //keycode控制
    item_current: '', //当前按下数字
    r_model: false, //键盘收起键控制
    longTap: false,//是否长按

    markComplete: false,
    isDisabled: true,

    answerlist: [],
    currentAnswerIndex: 0,
    answerScore: 0,
    startandText: "",
    startandImg: "",
    testType: 0,//1 选择题 2 判断题 3 主观题 4 填空题 10 多选题
    judgeAnswer: false,//判断题是否显示 正确答案  testTpye = 1
    judgeRule: "",

    swiper: {
      imgUrls: [],
      current: 0,
      swiper_type: true,
      allScore: 0,
      answer: '',
      standard: '',
      answer_img: ""
    },
    moreKeyCode: false, //弹起更多分数按钮
    no_papar: true, //有没有未批改的题，默认为 有
    score_bar: false, //打分浮框，显示与影藏
    coreCurrent: 0, //当前打分小题
    keyCode: [],
    keyCodeNum: 14, //键盘空白
    t_keyCode: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, '···'],
    answerArr: [], //答案数据
    
    flag: true, //控制打分开关，防止过快点击
    answerData: [], //答案，划线，文字，集合
    
    answerModel: false, //参考答案弹窗
    picHeight: 0,
    picTop: 0,
    move_start_x: 0, //移动初始x值
    paperModel: false,
    tabType: 1, //tab用来切换题目 答案  参考答案
   
    transverse: false,
    flag_slide: false, //滑动开关，用于控制用户滑动跟缩放行为

    imgload_height: '',
    imgload_width: '',
    screenWidth: '', //设备屏幕宽度
    screenHeight: '', //设备屏幕高度
    
    topic_flag: false, //查看题目
    show_student_list: false, //显示学生姓名列表

    set_flag: false,//多选题规则设置
  },

  initGetData(examId, id, aid) { //初始化   获取所有答卷
    findStudentUion({
      examId: examId,
      questionId: id
    }).then(res => {
        this.handleResData(resdata, 1, aid);
    })
  },

  handleResData(res, flag, aid) {
    console.log("处理返回的所有数据：", res)
    let _this = this;
    if (res.code == 10000) {
      if (!res.data) {
        this.setData({
          markComplete: true,
          page_title: title.indexOf("待批阅") != -1 ? "待批阅： 0" : title
        })
        return
      }
      let testType = _this.data.testType;
      let judgeAnswer = _this.data.judgeAnswer;
      let startandText = _this.data.startandText,
        startandImg = _this.data.startandImg;
      let judgeRule = _this.data.judgeRule;
      let answerScore = _this.data.answerScore;
      let curpage = _this.data.curpage;
      let answerdata = [];
      if(flag == 1){
        //试题  类型
        let res_type = res.data.type;
        if (res_type == 1 || res_type == 2) {
          testType = 1
          judgeAnswer = !this.data.transverse ? true : false;
        } else if (res_type == 10) {
          testType = 2 //多选题
        } else if (res_type == 3) {
          testType = 3
        } else if (res_type == 4) {
          testType = 4
        }
        //学生答卷所有数据
        answerdata = res.data.TopicData;
        //试题  答案  （主观题和客观题）
        let testAnswer = res.data.answer;
        if (testType == 1) {
          startandText = testAnswer || "";
        } else {
          startandImg = res.data.answer;
          if (testAnswer.length) {
            testAnswer = JSON.parse(res.data.answer) || [];
          }
          startandImg = testAnswer[0] ? testAnswer[0].url : '';
        }
        //多选题  规则
        judgeRule = res.data.rule ? res.data.rule : [4, 2, 1, 0]; 
        //试题  总分值
        answerScore = res.data.score || 0;
        if (res.data.check) {
          curpage = Math.ceil((res.data.check + 1) / 10);
        }
      }else{
        answerdata = res.data;
      }
      
      //学生答卷所有数据 计算部分属性
      for (let j = 0; j < answerdata.length; j++) {
        var item = answerdata[j],
          newAnswer = [],
          oss_urls = [];
        var reg = new RegExp("\\\\", "g");
        if (reg.test(item.answerPostion)) {
          item.answerPostion = item.answerPostion.replace(reg, "");
          var start = item.answerPostion.indexOf("[");
          var end = item.answerPostion.indexOf("]");
          if (start != 0 || end != (item.answerPostion.length - 1)) {
            item.answerPostion = item.answerPostion.substring(start, end + 1);
          }
        }
        item.answerPostion = item.answerPostion ? JSON.parse(item.answerPostion) : [];
        if (item.answerPostion.length > 0) {
          item.answerPostion = item.answerPostion.filter(item => {
            var pic_url = item.url;
            item.url = pic_url.substring(0, pic_url.indexOf('?') != -1 ? pic_url.indexOf('?') : 9999);
            var w = parseInt(item.width);
            var h = parseInt(item.height);
            var x = parseInt(item.positionX);
            var y = parseInt(item.positionY);
            if (pic_url.indexOf('?') != -1) {
              item.oss_url = pic_url.substring(pic_url.indexOf('?') + 1);
            }
            if (item.oss_url == '') {
              item.oss_url += `x-oss-process=image/crop,x_${x},y_${y},h_${h},w_${w}`
            }
            item.default_height = h;
            item.default_width = w;
            return item;
          })
        }
        if (reg.test(item.studentNamePic)) {
          item.studentNamePic = item.studentNamePic.replace(reg, "");
          var start = item.studentNamePic.indexOf("[");
          var end = item.studentNamePic.indexOf("]");
          if (start != 0 || end != (item.studentNamePic.length - 1)) {
            item.studentNamePic = item.studentNamePic.substring(start, end + 1);
          }
        }
        item.studentNamePic = item.studentNamePic ? JSON.parse(item.studentNamePic) : [];
      }
      let currentAnswerIndex = 0;//重置当前答卷索引
      var len = answerdata.length;
      //计算未打分答卷
      let unfinish = answerdata.filter(item => {
        return item.score == null;
      })
      let settitle = unfinish.length ? '待批阅：' + unfinish.length : '回评卷';
      
      if (aid) {
        var currentIndex = answerdata.findIndex(item => item.id == aid);
        if (currentIndex != -1) {
          currentAnswerIndex = currentIndex;
        }
      }
      
      _this.setData({
        page_title: settitle,
        answerlist: answerdata,
        currentAnswerIndex,
        answerScore,
        testType,
        coreCurrent: 0,
        markComplete: false,
        back: unfinish.length ? false : true,
        curpage,
        judgeAnswer
      })
      _this.getPaperInfo(answerdata[currentAnswerIndex].symbolMark); //初始化页面线条等
      _this.getScore(answerdata[currentAnswerIndex].score); //初始化页面分值
    } else if (res.code == 10029) {
      this.setData({
        page_title: '待批阅： 0',
        markComplete: true
      })
    }else{
      console.log("接口请求出错")
    }
  },

  resetData(){//重置数据
    this.setData({
      scoreMark: {},
      textMark: [],
      lineMark: [],

      answerlist: [],
      currentAnswerIndex: 0,
      answerScore: 0,
      startandText: "",
      startandImg: "",
      testType: 0,
      judgeAnswer: false,
      judgeRule: [],

      keyCode: [],
      markComplete: false,
      show_student_list: false
    })
  },

  onLoad(query) {
    console.log("onLoad",query)
    if (query.questionId) {
      this.setData({
        examId: query.examId,
        questionId: query.questionId,
        back: query.back == 'false'?false:true,
        page_title: query.back == 'false'?'阅卷':'回评卷'
      })
      this.initGetData(query.examId, query.questionId);
      // if (query.back == 'false') {
      //   this.getCheched(query.examId, query.questionId);
      // } else {
      //   console.log('进入回评')
      //   this.findChecked(query.examId, query.questionId);
      // }
    }
  },
  onReady() {
    console.log("onReady")
    var _this = this;
    // 页面加载完成
    _this.getVh();
  },
  onShow: function () {
    console.log('页面显示')
    var comment = app.globalData.commentData;
    largeTimes = 0;
    //this.nextQuestion();
    if (Object.keys(comment).length > 0) {
      console.log(comment)
      comment.studentNamePic = comment.studentNamePic ? JSON.parse(comment.studentNamePic) : [];
      this.setData({
        page_title: "回评卷",
        imgcomplete: false
      })
      this.handleTopic(comment);
    }
    this.setData({
      yes: true,  //移动
      close: true, //划线
      line: true,  //备注
      text: true,  //收藏
      clear: true, //正确答案
      float_bar: false,
      'swiper.swiper_type.': true,
    })
    
  },
  onHide() {
    // 页面隐藏
    console.log('onhide')
  },
  onUnload() {
    // 页面被关闭
    console.log('onUnload')
    this.resetData();
  },

  scoreHandle(data) {
    let score = data.detail;
    let answerlist = this.data.answerlist;
    let current = this.data.currentAnswerIndex;
    var newAnserObj = answerlist[current];
    let scoreMark = this.data.scoreMark;
    let answerScore = this.data.answerScore;
    newAnserObj.score = score;
    newAnserObj.makingTime = new Date();
    let icon;
    if (score == 0) {
      icon = 1; //错误 ×
    } else if (score > 0) {
      if (score == answerScore) {
        icon = 2; //全对 √
      } else {
        icon = 3; //部分正确 
      }
    }
    scoreMark = {
      icon: icon,
      x: 0,
      score: "+ " + score,
      y: 0
    }
    this.setData({
      scoreMark
    })
    this.sendAnswer(newAnserObj);
  },

  sendAnswer(data) { //发送答案
    if (!data) {
      return
    }
    data.answerPostion = JSON.stringify(data.answerPostion);
    data.symbolMark = this.optionCon();
    data.studentNamePic = JSON.stringify(data.studentNamePic);
    updateTopic(JSON.stringify(data)).then((res) => {
      console.log('评分完成返回数据：', res)
      if (res.code == 10000) {
        if(!this.data.back && res.data.residue == 0){
          this.setData({
            no_papar: false,
            uncomplete_num: 0
          })
          return false
        }
      }else{
        console.log("更新数据出错了");
      }
    }).catch(res => {
      this.errorFun();
    })
  },

  

  

  /*打开学生姓名下拉框*/
  openStudent() {
    if (!this.data.no_papar) return false;
    var answerImgs = this.data.swiper.imgUrls;
    for (let i in answerImgs) {
      var item = answerImgs[i];
      if (!item.studentNamePic[0].url) {
        item.studentNamePic = JSON.parse(item.studentNamePic);
      }
    }
    this.setData({
      show_student_list: !this.data.show_student_list,
      'swiper.imgUrls': answerImgs
    })
  },
  /*点击选中一个学生姓名*/
  selectStudentId(e) {
    var datas = e.currentTarget.dataset;
    var studentId = datas.uid,examId = datas.eid,questionId = datas.qid,_index = datas.index,aid = datas.aid;
    var swiper = this.data.swiper;
    var curindex = swiper.imgUrls.findIndex(item => item.id == aid);
    console.log("当前选中学生index：",curindex)
    if(swiper.current == curindex){
      this.setData({
        show_student_list: false,
      })
      return false;
    };
    var item = swiper.imgUrls[curindex];
    swiper.current = curindex;
    this.setData({
      swiper,
      show_student_list: false,
      imgcomplete: false,
      'swiper.swiper_type.': true,
    })
    console.log("当前选中学生item：",item)
    console.log("所有答卷：",swiper)
    
    this.handleTopic(item);
  },
  /*topbar图标控制事件*/
  yesup: function (e) {
    var type = e.currentTarget.dataset['type'];
    if (!this.data.no_papar || !this.data.imgcomplete) {
      return;
    }
    var swiper = this.data.swiper;
    var testType = this.data.testType;
    if (type == 1) {
      this.setData({
        yes: false,  //移动
        close: true, //划线
        line: true,  //备注
        text: true,  //收藏
        clear: true, //正确答案
        float_bar: false,  //划线、备注浮动菜单
        show_student_list: false
      })
    } else if (type == 2) {
      if (testType == 1) {return}
      this.setData({
        yes: true,  //移动
        close: false, //划线
        line: true,  //备注
        text: true,  //收藏
        clear: true, //正确答案
        //lineCanvas: true,
        float_bar: true,
        float_type: 1,
        show_student_list: false
      })
    } else if (type == 3) {
      if (testType == 1) {return}
      this.setData({
        yes: true,  //移动
        close: true, //划线
        line: false,  //备注
        text: true,  //收藏
        clear: true, //正确答案
        textEnd: false,
        float_bar: true,
        float_type: 2,
        t_top: default_text_top,
        t_left: default_text_left,
        show_student_list: false
      })
    } else if (type == 4) {
      this.setData({
        yes: true,  //移动
        close: true, //划线
        line: true,  //备注
        text: false,  //收藏
        clear: true, //正确答案
        float_bar: false,
        show_student_list: false
      })
      var questionId = swiper.imgUrls[swiper.current].questionId;
      var examId = swiper.imgUrls[swiper.current].examId;
      var id = swiper.imgUrls[swiper.current].id;
      console.log(questionId,examId,id)
      wx.navigateTo({
        url: '/pages/mycollec/mycollec?questionId=' + questionId + '&examId=' + examId + '&id=' + id,
      })
    } else if (type == 5) {
      var answer_pic = swiper.answer.length > 0 ? swiper.answer[0].url : '';
      var answer_img = swiper.answer_img;
      var judgeAnswer = this.data.judgeAnswer;
      judgeAnswer = testType == 1;
      if((testType != 1 && !answer_img) || (testType == 1 && !swiper.standard)){
        wx.showToast({
          title: "暂无答案",
          icon: "none"
        })
        return false
      }
      this.setData({
        yes: true,  //移动
        close: true, //划线
        line: true,  //备注
        text: true,  //收藏
        clear: false, //正确答案
        float_bar: false,
        topic_flag: true,
        'swiper.answer_img': answer_img,
        judgeAnswer,
        show_student_list: false
      })
    }
  },
  yesdown: function () {},
  /*回评本题 / 评阅下一题 / 返回列表 按钮*/
  endHandle(e) {
    var type = e.currentTarget.dataset.type;
    if (type == 1) {
      this.reviewPaper();
    } else if (type == 2) {
      if(this.data.back){
        wx.navigateBack({
          delta: 1
        })
      }else{
        this.nextQuestion();
      }
    }
  },
   /*子组件 对错判断 事件*/
  onCounterPlusOne(data) {
    console.log('组件函数', data);
    var index = data.detail;
    var swiper = this.data.swiper;
    var current = swiper.current;
    var newAnserObj = swiper.imgUrls[current];
    newAnserObj.score = index;
    newAnserObj.makingTime = new Date();
    var picHeight = this.data.imgload_height;
    var picWidth = this.data.imgload_width;
    var scoreMark = {};
    var y = 0;
    var x = 0;
    var arr = [];
    // var icon = (index + '').indexOf('.') == -1 ? true : false;
    var icon;
    //重置打分规则
    var allScore = swiper.allScore;
    if(index == 0) {
      icon = 1;//错误 ×
    }else if(index > 0){
      if(index == allScore){
        icon = 2;//全对 √
      }else{
        icon = 3;//部分正确 
      }
    }
    scoreMark = {
      icon: icon,
      x: x,
      score: index == 0 ? 0 : '+ ' + index,
      y: y
    }
    this.setData({
      scoreMark
    })
    
    this.sendAnswer(newAnserObj);
  },
  /*子组件   回评本题 / 评阅下一题 / 返回列表 按钮*/
  backHandle(e) {
    var type = e.detail.type;
    if (type == 1) { //回评本题
      this.reviewPaper();
    } else { //批阅下一题  返回列表
      if(this.data.back){
        wx.navigateBack({
          delta: 1
        })
      }else{
        this.nextQuestion();
      }
    }
  },
  /*回评本题*/
  reviewPaper() {
    var swiper = this.data.swiper;
    var questionId = swiper.imgUrls[0].questionId;
    var examId = swiper.imgUrls[0].examId;
    this.findChecked(examId, questionId);
    this.setData({
      title: '回评卷',
      page_title: '回评卷',
      back: true
    })
  },
  //评阅下一题
  nextQuestion(){
    var _this = this;
    var examId = _this.data.examId,questionId = _this.data.questionId,back = _this.data.back;
    findAllexaminfo({
      examId: examId
    }).then((res) => {
      if (res.code == 10000 && res.data != null && res.data.length != 0) {
        console.log(res.data)
        var exams = res.data,next_questionid;
        var complete = exams.filter(item => {
          return item.markAll != item.checkAll;
        })
        if(complete.length == 0){
          wx.showToast({
            title: '所有题块已批阅',
            icon: 'none',
            success: () => {
              var timer1 = setTimeout(() => {
                wx.navigateBack({
                  delta: 1
                })
                clearTimeout(timer1)
              }, 1500)
            }
          })
          return false;
        }else{
          next_questionid = exams[0].questionId;
          _this.getCheched(examId, next_questionid);
        }
        _this.setData({
          scoreMark: {},
          lineMark: [],
          textMark: [],
          current: -1,
          item_current: "",
          questionId: next_questionid,
          back: false
        })
      }
    }).catch(res=>{
      this.errorFun();
    })
  },
  /*开始批阅下一题*/
  startNextPaper() {
    var examInfo = app.globalData.examInfo;
    var that = this;
    var arr = [];
    for (var key in examInfo) {
      var obj = {};
      obj.check = examInfo[key].checkAll;
      obj.markAll = examInfo[key].markAll;
      obj.questionId = examInfo[key].questionId;
      arr.push(obj);
    }
    var len = arr.length;
    var swiper = this.data.swiper;
    var questionId = swiper.imgUrls[0].questionId;
    var index = arr.findIndex(item => item.questionId == questionId);
    var examId = swiper.imgUrls[0].examId;;
    /*递归调用*/
    function nextPaper(n) {
      if (n < len) {
        if (arr[n].markAll == arr[n].checkAll) { //如果下一题已经批阅完，就再下一题
          nextPaper(n + 1);
        } else {
          var next_questionid = arr[index + 1].questionId;
          that.getCheched(examId, next_questionid);
        }
      } else {
        wx.showToast({
          title: '所有题块已批阅',
          icon: 'none',
          success: () => {
            var timer1 = setTimeout(() => {
              wx.navigateBack({
                delta: 1
              })
              clearTimeout(timer1)
            }, 1500)
          }
        })
      }
    }
    nextPaper(index + 1);
  },
  openAnswer(e) { //打开参考答案弹窗
    var type = e.currentTarget.dataset.type;
    if (type == 4) {
      this.setData({
        marePic: false,
        answerModel: true
      })
    } else if (type == 3) {
      this.setData({
        marePic: true,
        answerModel: true
      })
    } else if (type == 2) {
      this.setData({
        paperModel: true
      })
    }
  },
  closeAnswer() {
    this.setData({
      topic_flag: false,
      clear: true,
      yes: false
    })
  },
  /*点击放大图片，（增大坐标）*/
  enlargeHandle(e) {
    var swiper = this.data.swiper,current = swiper.current,imgUrl = swiper.imgUrls[current];
    var answers = imgUrl.answerPostion;
    var isLarge = this.data.isLarge;
    if(largeTimes < 3){
      largeTimes ++;
    }else{
      largeTimes = 0;
    }
    isLarge = !(largeTimes == 3);
    for(var j in answers){
      var answer = answers[j];
      var y = answer.positionY,h = answer.default_height;
      var oss_arr = answer.oss_url;
      var markY = y - largeTimes * 10;
      markY = Math.floor(markY);
      var markH = h + largeTimes * 20;
      markH = Math.floor(markH);
      oss_arr = oss_arr.split(",");
      var new_oss = [];
      for (let i = 0; i < oss_arr.length; i++) {
        var oss = oss_arr[i];
        if (oss.indexOf('y_') != -1) {
          var ossy = oss.substring(oss.indexOf('y_'),2);
          ossy += markY * 1;
          new_oss.push(ossy);
        }else if (oss.indexOf('h_') != -1) {
          var ossh = oss.substring(oss.indexOf('h_'),2);
          ossh += markH * 1;
          new_oss.push(ossh);
        }else{
          new_oss.push(oss);
        }
      }
      answer.height = markH * 1;
      answer.oss_url = new_oss.join(",");
    }
    
    console.log(swiper)
    this.setData({
      swiper,
      isLarge
    })
  },
  //拖动点击放大图标
  enlargeMove(e) {
    var left = e.touches[0].clientX;
    var top = e.touches[0].clientY;
    var vw = this.data.screenWidth,vh = this.data.screenHeight;
    if(vw - left < 20) left = vw - 20;
    if(vh - top < 20) top = vh - 20;
    if(left < 20) left = 20;
    if(top < 20) top = 20;
    
    this.setData({
      enlargeX: left,
      enlargeY: top
    })
  },
  imgload(e) {
    var _data = this.data;
    var canvasw = 0, canvash = 0;
    var answerlist = _data.answerlist,
    currentAnswerIndex = _data.currentAnswerIndex;
    var answers = answerlist[currentAnswerIndex].answerPostion;
    console.log('imgload', e);
    imgobj = e ? e : '';
    
    this.setData({
      imgcomplete: true
    })
    
    var screenWidth = _data.screenWidth,screenHeight = _data.screenHeight;
    var transverse = _data.transverse;
    var vw = _data.vw,
      vh = _data.vh;
    var text_top = 0,
      text_left = 0;
    
    var common_width = vw * 0.95,
      common_height = vh * 0.95;
    if (!vw || !vh) {
      console.log("获取宽高失败")
      this.getVh().then(() => {
        this.imgload(imgobj);
      })
      return false;
    }
    this.setData({
      enlargeX: screenWidth * 0.75,
      enlargeY: transverse ? 40 : screenHeight * 0.75
    })
    if(!answers[0].url){
      answers = JSON.parse(answers) || [];
    }
    if (answers.length) {
      var imgload_width = 0,imgload_height = 0;
      var scale = (common_width / answers[0].width)<(common_height / answers[0].height)?(common_width / answers[0].width):(common_height / answers[0].height);
      answers.forEach(item => {
        var scale_width = common_width / item.width,
          scale_height = common_height / item.height;
        item.scale = scale_width < scale_height ? scale_width : scale_height;
        if (item.scale < scale) {
          scale = item.scale;
        }
      })
      imgload_width = common_width * 1;
      for (var i = 0; i < answers.length; i++) {
        answers[i].imgload_vw = answers[i].width * scale;
        answers[i].imgload_vh = answers[i].height * scale;
        imgload_height += answers[i].height * scale * 1;
      }
      text_top = imgload_height / 2, text_left = imgload_width / 2;
      default_text_top = text_top;
      default_text_left = text_left;
      canvasw = imgload_width, canvash = imgload_height;
      this.setData({
        answerlist,
        imgload_width,
        imgload_height,
        t_top: text_top,
        t_left: text_left,
        flag: true
      })
    }
    // if (canvasw && canvash && imgUrl.symbolPic){
    //   console.log("imgload 图片绘画痕迹： ", imgUrl.symbolPic)
    //   this.context.drawImage(imgUrl.symbolPic, 0, 0, canvasw, canvash);
    //   this.context.draw(true);
    // }
  },
  //图片加载失败
  imageOnLoadError(){
    console.log('图片加载失败');
    wx.showToast({
      title: "图片加载失败",
      icon: "none"
    })
  },
  prevImg: function () {
    console.log('上一题')
    var swiper = this.data.swiper;
    var imgUrls = swiper.imgUrls;
    var current = swiper.current;
    var curItem = swiper.imgUrls[current];
    var answerData = this.data.answerData;
    var answer = this.data.answerArr;
    var alldata = this.data.totalnum,curpage = this.data.curpage,allpage = this.data.allpage,back = this.data.back;
    for (let j = 0; j < answer.length; j++) {
      answer[j].value = '';
    }
    var id = '';
    
    largeTimes = 0;
    lineArrays = [];
    textArrays = [];

    if (current > 0) {
      current = current - 1;
      this.setData({ //清空图片上的图标线条
        scoreMark: {},// errorIconData: [],
        textMark: [],// textData: [],
        lineMark: [],// canvasData: [],
        yes: true,
        close: true,
        line: true,
        text: true,
        clear: true,
        answerArr: answer,
        score_bar: false,
        float_bar: false,
        imgcomplete: false
      })
      //id = swiper.imgUrls[current].id;
      for (var i in imgUrls) {
        if (typeof (imgUrls[i].answerPostion) == "string") {
          imgUrls[i].answerPostion = JSON.parse(imgUrls[i].answerPostion);
        }
        if (typeof (imgUrls[i].studentNamePic) == "string") {
          imgUrls[i].studentNamePic = JSON.parse(imgUrls[i].studentNamePic);
        }
      }
      var item = imgUrls[current];
      this.getPaperInfo(item.symbolMark);
      this.getScore(item.score);
      this.getNextImg();
    }else{
      if(curpage == 1){
        wx.showToast({
          title: "已经是第一张了",
          icon: "none"
        })
        return false;
      }else{
        curpage--;
        this.setData({
          curpage
        })
        this.getTopic(curItem,-1);
      }
    }
    //swiper.current = current >= 0 ? current : 0;
    this.setData({
      'swiper.current': current >= 0 ? current : 0,
      'swiper.imgUrls': imgUrls,
      'swiper.swiper_type': false,
      float_bar: false,
      moreKeyCode: false,
      imgcomplete: false,
      show_student_list: false
    })
  },
  nextImg: function (data) {
    console.log('下一题');
    var examId = this.data.examId,questionId = this.data.questionId,back = this.data.back;
    var swiper = this.data.swiper;
    var current = swiper.current;
    var curItem = swiper.imgUrls[current];
    var alldata = this.data.totalnum,curpage = this.data.curpage,allpage = this.data.allpage;
    var title = this.data.title,page_title = this.data.page_title;
    var answerData = this.data.answerData;
    var answer = this.data.answerArr;
    var canvasw = this.data.imgload_width, canvash = this.data.imgload_height;

    var judge = swiper.imgUrls[current].id;
    var result = answerData.findIndex(item => item.id == judge);
    console.log(curItem.scoreStatus)
    if (result == -1 && !data || curItem.score == null) {//!curItem.scoreStatus
      wx.showToast({
        title: '请先批卷',
        icon: 'none',
        duration: 2000
      })
      return
    }
    var unImgurls = swiper.imgUrls.filter(item => {
      return item.score == null;
    })

    if((back && current == (swiper.imgUrls.length - 1)) || (unImgurls.length == 0 && !back)){
      console.log("临界点")
      for (let j = 0; j < answer.length; j++) {
        answer[j].value = '';
      }
      curpage++;
      var flag = back ? 2 : 1; //未打分1   已打分2
      this.setData({
        curpage
      })
      this.getTopic(curItem, 1, flag);
      this.setData({ //清空图片上的图标线条
        swiper,
        scoreMark: {},// errorIconData: [],
        textMark: [],// textData: [],
        lineMark: [],// canvasData: [],
        yes: true,
        close: true,
        line: true,
        text: true,
        clear: true,
        answerArr: answer,
        score_bar: false,
        float_bar: false,
      })
    }else{
      console.log("正常切换下一张答卷")
      if(current < (swiper.imgUrls.length - 1)){
        swiper.current = current + 1;
      }else{
        var idindex = unImgurls[0].id;
        var current = swiper.imgUrls.findIndex(item => item.id == idindex);
        swiper.current = current;
      }
      this.setData({ //清空图片上的图标线条
        scoreMark: {},// errorIconData: [],
        textMark: [],// textData: [],
        lineMark: [],// canvasData: [],
        yes: true,
        close: true,
        line: true,
        text: true,
        clear: true,
        answerArr: answer,
        score_bar: false,
        float_bar: false,
        moreKeyCode: false,
        current: -1,
        imgcomplete: false
      })
      this.getPaperInfo(swiper.imgUrls[swiper.current].symbolMark);
      this.getScore(swiper.imgUrls[swiper.current].score);
      this.getNextImg();
    }
    
    var nextimg = swiper.imgUrls.length - swiper.current;
    var setTitle = page_title.indexOf("待批阅") != -1 ? "待批阅： " + unImgurls.length : page_title;
    wx.setNavigationBarTitle({
      title: setTitle
    })
    this.setData({
      swiper,
      imgcomplete: false,
      page_title: setTitle,
      'swiper.swiper_type.': true,
      float_bar: false,
      show_student_list: false
    })
  },
  /*清楚当前页面操作的标记*/
  clearArrData() {
    if (!this.data.close) {
      this.setData({
        lineMark: []
      })
    } else if (!this.data.line) {
      this.setData({
        textMark: []
      })
    }
  },
  
  
  inputValue(e) { //输入完成触发
    console.log(e.detail)
    var textMark = this.data.textMark;//var input = this.data.textData;
    var obj = {
      x: this.data.t_left,
      y: this.data.t_top,
      value: e.detail.value
    }
    textMark.push(obj);//input.push(obj);
    textArrays.push(obj);//将输入完成之后的文字 坐标存入数组中
    this.setData({
      textMark,//textData: input,
      text: true,
      textEnd: true,
      textfocus: false,
      textFocusStatus: false
    })
  },
  /*禁止用户手指触摸滑动swiper*/
  stopTouchMove: function () {
    return false;
  },
  // 手指触摸事件
  EventHandleStart: function (e) {
    var _data = this.data;
    inTouch = true;
    lastTouchPoint = { x: 0, y: 0 };
    oldDist = 0;
    if(e.touches.length == 2){
      let xMove = e.touches[1].clientX - e.touches[0].clientX;
      let yMove = e.touches[1].clientY - e.touches[0].clientY;
      let distance = Math.sqrt(xMove * xMove + yMove * yMove);
      this.setData({
        'distance': distance,
      })
    }
    strat_x = e.touches[0].clientX; // 手指开始触摸时的x轴 x轴--->相对于画布左边的距离
    strat_y = e.touches[0].clientY; // 手指开始触摸时的y轴 y轴--->相对于画布顶部的距离
    var boxTop = _data.boxTop,boxLeft = _data.boxLeft,
      vw = _data.vw,
      vh = _data.vh,
      imgload_width = _data.imgload_width,
      imgload_height = _data.imgload_height,
    x_empty = (vw - imgload_width) / 2 + boxLeft;
    y_empty = (vh - imgload_height) / 2 + boxTop;
    if (!this.data.text) {
      this.setData({
        move_start_x: strat_x,
      })
    }
  },
  
  EventHandleMove(e) {
    var _data = this.data;
    if (_data.yes) return false;
    if (e.touches.length == 1) {
      var marginTop = this.data.marginTop;
      var marginLeft = this.data.marginLeft;
      var vw = this.data.vw,vh = this.data.vh;
      var imgload_width = this.getImgsSize().imgload_width, imgload_height = this.getImgsSize().imgload_height;
      if (lastTouchPoint.x == 0 && lastTouchPoint.y == 0) {
        lastTouchPoint.x = e.touches[0].clientX;
        lastTouchPoint.y = e.touches[0].clientY;
      } else {
        var xOffset = e.touches[0].clientX - lastTouchPoint.x;
        var yOffset = e.touches[0].clientY - lastTouchPoint.y;
        console.log(marginTop,marginLeft)
        console.log(e.touches[0].clientX, lastTouchPoint.x)
        console.log(e.touches[0].clientY, lastTouchPoint.y)
        console.log(xOffset,yOffset)
        marginTop += yOffset;
        marginLeft += xOffset;
        if(marginTop > 0){
          marginTop = 0;
        }
        if(marginLeft > 0){
          marginLeft = 0;
        }
        if(marginLeft < 0 && (imgload_width > vw && (imgload_width - Math.abs(marginLeft)) < vw)){
          console.log(imgload_width,marginLeft,vw)
          marginLeft = vw - imgload_width;
        }
        if(marginTop < 0 && (imgload_height > vh && (imgload_height - Math.abs(marginTop)) < vh)){
          console.log(imgload_height,marginTop,vh)
          marginTop = vh - imgload_height;
        }
        this.setData({
          marginTop,
          marginLeft,
        })
        lastTouchPoint.x = e.touches[0].clientX;
        lastTouchPoint.y = e.touches[0].clientY;
      }
    }
    if (e.touches.length == 2) {
      this.imgZoom(e);
      // if (oldDist == 0) {
      //   oldDist = this._spacing(e);
      // } else {
      //   newDist = this._spacing(e);
      //   this._zoom(newDist / oldDist, e);
      //   oldDist = newDist;
      // }
    }
  },
  //手指触摸结束时的事件
  EventHandle: function (e) {//划线
    var _data = this.data;
    end_x = e.changedTouches[0].clientX; // 手指结束触摸时的x轴 x轴--->相对于画布左边的距离
    end_y = e.changedTouches[0].clientY; // 手指结束触摸时的y轴 y轴--->相对于画布顶部的距离
    if (_data.yes && _data.close) {
      if (end_x > strat_x) { //向左滑动，显示上一题
        console.log('右滑')
        this.prevImg();
      } else if (end_x < strat_x) {
        console.log('左滑')
        this.nextImg();
      }
      return
    }
  },
  imgZoom(e){
    let xMove = e.touches[1].clientX - e.touches[0].clientX;
    let yMove = e.touches[1].clientY - e.touches[0].clientY;
    let distance = Math.sqrt(xMove * xMove + yMove * yMove);
    let distanceDiff = distance - this.data.distance;
    console.log(distanceDiff)
    //let newScale = this.data.scale + 0.005 * distanceDiff;
    let newScale = 0.005 * distanceDiff;
    let allScale = this.data.scale + newScale;

    var swiper = this.data.swiper, current = swiper.current, imgUrls = swiper.imgUrls;
    var answers = imgUrls[current].answerPostion;
    var marginLeft = this.data.marginLeft,marginTop = this.data.marginTop;

    var imgWidth = this.getImgsSize().imgload_width, imgHeight = this.getImgsSize().imgload_height;

    if (allScale >= 5 || allScale <= 1) {
      return false;
    }
    console.log(newScale)
    answers.forEach(item => {
      item.imgload_vw = item.imgload_vw * newScale;
      item.imgload_vh = item.imgload_vh * newScale;
    })
    this.setData({
      'distance': distance,
      'scale': allScale,
      'diff': distanceDiff,
      swiper,
      marginLeft: marginLeft + (imgWidth * distanceDiff) / 2,
      marginTop: marginTop + (imgHeight * distanceDiff) / 2
    })
  },
  //计算两指间距
  _spacing: function (e) {
    let x = (e.touches[0].x || e.touches[0].clientX) - (e.touches[1].x || e.touches[1].clientX);
    let y = (e.touches[0].y || e.touches[0].clientY) - (e.touches[1].y || e.touches[1].clientY);
    return Math.sqrt(x * x + y * y);
  },
  //计算多张图片的宽高
  getImgsSize(){
    var swiper = this.data.swiper, current = swiper.current, imgUrls = swiper.imgUrls;
    var answers = imgUrls[current].answerPostion;
    var imgload_width = answers[0].imgload_vw, imgload_height = 0;
    answers.forEach(item => {
      imgload_height += item.imgload_vh;
      if (item.imgload_vw > imgload_width) {
        imgload_width = item.imgload_vw
      }
    })
    return { imgload_width, imgload_height };
  },
  //计算x y轴上的双指中心点比例
  _calcRatio: function (e) {
    let x = (e.touches[0].x || e.touches[0].clientX) + (e.touches[1].x || e.touches[1].clientX);
    let y = (e.touches[0].y || e.touches[0].clientY) + (e.touches[1].y || e.touches[1].clientY);

    var imgload_width = this.getImgsSize().imgload_width, imgload_height = this.getImgsSize().imgload_height;

    var yRatio = (y / 2 - this.data.marginTop) / imgload_height;
    var xRatio = (x / 2 - this.data.marginLeft) / imgload_width;
    return { xRatio, yRatio }
  },
  _zoom(f, e) {
    var ratio = 1;
    var xRatio = this._calcRatio(e).xRatio;
    var yRatio = this._calcRatio(e).yRatio;
    var swiper = this.data.swiper, current = swiper.current, imgUrls = swiper.imgUrls;
    var answers = imgUrls[current].answerPostion;
    var view_width = this.data.vw, view_height = this.data.vh;

    var marginLeft = this.data.marginLeft,marginTop = this.data.marginTop;

    var imgWidth = this.getImgsSize().imgload_width, imgHeight = this.getImgsSize().imgload_height;

    answers.forEach(item => {
      item.imgload_vw = item.imgload_vw * f < item.imgload_vw ? item.imgload_vw : item.imgload_vw * f;
      item.imgload_vh = item.imgload_vh * f < item.imgload_vh ? item.imgload_vh : item.imgload_vh * f;
    })
    this.setData({
      marginLeft: marginLeft + xRatio * imgWidth * (1 - f),
      marginTop: marginTop + yRatio * imgHeight * (1 - f),
      swiper
    })
  },
  /*处理各种跳回来的题*/
  handleTopic(data) {
    if (!data) {
      return
    }
    if (data.id) {
      var swiper = this.data.swiper;
      var current = swiper.current;
      console.log("当前所有答卷：",swiper)
      var imgcomplete = this.data.imgcomplete;
      var len = swiper.imgUrls.length > 0 ? swiper.imgUrls.length - 1 : 0
      var curIndex = swiper.imgUrls.findIndex(item => item.id == data.id);
      console.log("当前答卷item：",data)
      console.log("当前答卷index：",curIndex)
      if (current == -1 || curIndex == -1 || curIndex == undefined) {
        console.log('当前没有试卷')
        if (!data.answerPostion[0].url) {
          data.answerPostion = JSON.parse(data.answerPostion) || [];
        }
        data.answerPostion.forEach(item=>{
          var pic_url = item.url;
          item.url = pic_url.substring(0, pic_url.indexOf('?') != -1 ? pic_url.indexOf('?') : 9999);
          var w = parseInt(item.width);
          var h = parseInt(item.height);
          var x = parseInt(item.positionX);
          var y = parseInt(item.positionY);
          if (pic_url.indexOf('?') != -1) {
            item.oss_url = pic_url.substring(pic_url.indexOf('?') + 1);
          }
          if (item.oss_url == '') {
            item.oss_url += `x-oss-process=image/crop,x_${x},y_${y},h_${h},w_${w}`
          }
          item.default_height = h;
          item.default_width = w;
        })
        
        console.log(data)
        swiper.imgUrls = [];
        swiper.imgUrls.push(data);
        swiper.current = 0;
      } else {
        console.log('中途')
        largeTimes = 0;
        lineArrays = [];
        textArrays = [];
        
        var answerImgs = swiper.imgUrls;
        for (let i in answerImgs) {
          var item = answerImgs[i];
          if (!item.answerPostion[0].url) {
            item.answerPostion = JSON.parse(item.answerPostion);
          }
        }
        
        swiper.current = curIndex;
        if(data.id == swiper.imgUrls[swiper.current].id){
          imgcomplete = true;
        };
      }
      console.log(swiper)
      this.setData({
        swiper: swiper,
        scoreMark: {},// errorIconData: [],
        textMark: [],// textData: [],
        lineMark: [],// canvasData: [],
        current: -1,
        no_papar: true,
        imgcomplete,
        'swiper.swiper_type.': true,
      })
      this.getPaperInfo(data.symbolMark);
      this.getScore(data.score);
      app.globalData.commentData = {};
    }
  },
  
  getScore(data) {
    var answer = this.data.answerArr;
    var score = data;
    var testTpye = this.data.testType;
    var allScore = this.data.swiper.allScore;
    console.log(score, 'score')
    if(testTpye == 1 && score != null){
      var scoreMark = {
        type: "",
        icon: score == allScore ? 2 : 1,
        x: 0,
        y: 0,
        score: "+ " + score,
      }
      this.setData({
        scoreMark
      })
    }else{
      for (let i = 0; i < answer.length; i++) {
        answer[i].value = score;
      }
      var keycode = answer[0].allowValue;
      this.computedKeycode(keycode);
      this.setData({
        answerArr: answer,
        score_bar: true,
        moreKeyCode: false
      })
    }
  },
  getPaperInfo(data) {
    // if (!data) {
    //   return
    // }
    //this.clearCanvas();
    var scoreMark = {}, textMark = [], lineMark = [];
    var current = this.data.current;
    var totalnum = this.data.totalnum;
    if(!!data){
      var arrs = data.split('\t');
      for (let i in arrs) {
        var arr = arrs[i].split('$');
        if (arr[0] == "right" || arr[0] == "error") {//初始化打分
          if (arr[4]) {
            var score = (arr[4] == 0?arr[4]:arr[4].split(' ')[1]) || arr[4];
            current = Math.floor(score);
          }
          scoreMark = {
            type: arr[0],
            icon: arr[1],
            x: arr[2],
            y: arr[3],
            score: arr[4] != null ? arr[4] : "",
          }
        }else if(arr[0] == "line"){//初始化划线
          var lineObj = {};
          lineObj = {
            left: arr[1] * 1,
            top: arr[2] * 1,
            width: arr[3] * 1,
            deg: arr[4] * 1
          }
          lineMark.push(lineObj);
          //lineArrays = lineMark;
        }else if(arr[0] == "text"){//初始化文字备注
          var textObj = {};
          textObj = {
            x: arr[1] * 1,
            y: arr[2] * 1,
            value: arr[3] == 'NaN'?'':arr[3]
          }
          textMark.push(textObj);
          //textArrays = textMark;
        }
      }
      oldLine = lineMark.length || 0;
      oldText = textMark.length || 0;
    }
    console.log(current)
    this.setData({
      scoreMark,// textData: textData,
      textMark, // errorIconData: errorData,
      lineMark,// canvasData: lineData,
      current,
      moreKeyCode: false,
      item_current: '',
      enlargeX: this.data.screenWidth * 0.8,
      enlargeY: this.data.screenHeight * 0.75,
      allpage: Math.ceil(totalnum / 10),
      isClear: false
    })
    
    console.log(this.data.scoreMark,this.data.lineMark,this.data.textMark,this.data.current)
  },
  optionCon() {
    var scoreMark = this.data.scoreMark; //分值
    var textMark = this.data.textMark;//文字标记
    var lineMark = this.data.lineMark;//划线标记
    var con = '';
    // right$x$y$	
    if(scoreMark.icon){
      var type = scoreMark.icon ? 'right' : 'error';
      con += type + '$' + scoreMark.icon + '$' + scoreMark.x + '$' + scoreMark.y + '$' + scoreMark.score + "\t";
    }
    lineMark.forEach(item => {
      con += 'line' + '$' + item.left.toFixed(1) + '$' + item.top.toFixed(1) + '$' + item.width.toFixed(1) + '$' + item.deg.toFixed(1) + '$' + "\t";
    })
    textMark.forEach(item => {
      con += 'text' + '$' + item.x + '$' + item.y + '$' + item.value + '$' + "\t";
    })
    return con;
  },
  
  
  
  getTopic(data,type,flag) {
    if (!data) {
      return
    };
    flag = flag || 2;
    var page = this.data.curpage;
    data.answerPostion = JSON.stringify(data.answerPostion);
    data.studentNamePic = JSON.stringify(data.studentNamePic);
    var examId = data.examId,questionId = data.questionId,aid = data.id;
    findChecked({
      examId: examId,
      questionId: questionId,
      id: aid,
      type: type,
      page: page
    }).then((res) => {
      this.mainHandle(res, 2);
    }).catch(res => {
      this.errorFun();
    })
  },
  findChecked(examId, questionId,aid) { //请求已经评卷过的题块
    var curpage = this.data.curpage;
    if (!examId || !questionId) {
      return
    }
    findStudentUion({
      examId: examId,
      questionId: questionId,
      page: curpage
    }).then((res) => {
      this.mainHandle(res, 1, aid);
    }).then((res) => {
      this.getNextImg();
    }).catch(res => {
      
    })
  },
  
  getCheched(examId, id, aid) { //获取评卷中所有未打分题目
    var title = this.data.page_title;
    var curpage = this.data.curpage;
    getUnchecked({
      examId: examId,
      questionId: id,
      page: curpage
    }).then(res => {
      console.log(res)
      if (res.code == 10000) {
        if (!res.data) {
          //var swiper = this.data.swiper;
          this.setData({
            no_papar: false,
            page_title: title.indexOf("待批阅") != -1?"待批阅： 0":title
            //'swiper.current': swiper.current + 1
          })
          return
        }
        largeTimes = 0;
        var testType = this.data.testType;
        var judgeAnswer = this.data.judgeAnswer;
        if (res.data.type == 1 || res.data.type == 2) {
          testType = 1
          judgeAnswer = !this.data.transverse?true:false;
        } else if (res.data.type == 10) {
          testType = 2 //多选题
        } else if (res.data.type == 3) {
          testType = 3
        } else if (res.data.type == 4) {
          testType = 4
        }
        var swiper = this.data.swiper;
        var picdata = res.data.TopicData;
        if(testType != 1 && res.data.answer.length != 0){
          var answerImg = JSON.parse(res.data.answer) || [];
          swiper.answer_img = answerImg[0] ? answerImg[0].url : '';
        }
        swiper.rule = res.data.rule?res.data.rule:[4,2,1,0]; //多选题规则
        var oss_url = "";
        for (let j = 0; j < picdata.length; j++) {
          var item = picdata[j],newAnswer = [],oss_urls=[];
          var reg = new RegExp("\\\\","g");
          if(reg.test(item.answerPostion)){
            item.answerPostion = item.answerPostion.replace(reg, "");
            var start = item.answerPostion.indexOf("[");
            var end = item.answerPostion.indexOf("]");
            if(start != 0 || end != (item.answerPostion.length-1)){
              item.answerPostion = item.answerPostion.substring(start,end+1);
            }
          }
          item.answerPostion = item.answerPostion ? JSON.parse(item.answerPostion) : [];
          if (item.answerPostion.length > 0) {
            item.answerPostion = item.answerPostion.filter(item => {
              var pic_url = item.url;
              item.url = pic_url.substring(0, pic_url.indexOf('?') != -1 ? pic_url.indexOf('?') : 9999);
              var w = parseInt(item.width);
              var h = parseInt(item.height);
              var x = parseInt(item.positionX);
              var y = parseInt(item.positionY);
              if (pic_url.indexOf('?') != -1) {
                item.oss_url = pic_url.substring(pic_url.indexOf('?') + 1);
                oss_url = pic_url.substring(pic_url.indexOf('?') + 1);
              }
              if(oss_url == ''){
                oss_url += `x-oss-process=image/crop,x_${x},y_${y},h_${h},w_${w}`;
              }
              if (item.oss_url == '') {
                item.oss_url += `x-oss-process=image/crop,x_${x},y_${y},h_${h},w_${w}`
              }
              item.default_height = h;
              item.default_width = w;
              return item;
            })
          }
          if(reg.test(item.studentNamePic)){
            item.studentNamePic = item.studentNamePic.replace(reg, "");
            var start = item.studentNamePic.indexOf("[");
            var end = item.studentNamePic.indexOf("]");
            if(start != 0 || end != (item.studentNamePic.length-1)){
              item.studentNamePic = item.studentNamePic.substring(start,end+1);
              console.log(item.studentNamePic)
            }
          }
          item.studentNamePic = item.studentNamePic ? JSON.parse(item.studentNamePic) : [];
        }
        console.log(picdata)
        swiper.imgUrls = picdata;
        swiper.current = 0;
        if(aid){
          var currentIndex = swiper.imgUrls.findIndex(item => item.id == aid);
          if(currentIndex != -1){
            swiper.current = currentIndex;
          }
        }
        var len = picdata.length;
        swiper.allScore = res.data.score;
        swiper.answer = res.data.questionPic ? JSON.parse(res.data.questionPic) : [];
        swiper.standard = res.data.answer; //参考答案
        swiper.rule = res.data.rule?res.data.rule:[4,2,1,0]; //多选题规则
        
        var answerArr = [];
        answerArr.push({
          value: '',
          allowValue: this.getNumber(res.data.score)
        })
        var arr = this.getNumber(res.data.score)
        this.computedKeycode(arr);
        var unfinish = picdata.filter(item => {
          return item.score == null;
        })
        var settitle = unfinish.length?'待批阅：' + unfinish.length:'回评卷';
        wx.setNavigationBarTitle({
          title: settitle
        })
        var keyrow = Math.ceil(res.data.score / 6);
        var curpage = this.data.curpage;
        
        if(res.data.check){
          curpage = Math.ceil((res.data.check + 1) / 10);
        }
        this.setData({
          page_title: settitle,
          oss_url: oss_url,
          swiper: swiper,
          testType,
          coreCurrent: 0,
          answerArr: answerArr,
          no_papar: true,
          keyrows: keyrow,
          back: unfinish.length?false:true,
          curpage,
          judgeAnswer
        })
        this.getPaperInfo(swiper.imgUrls[swiper.current].symbolMark);//初始化页面线条等
        this.getScore(swiper.imgUrls[swiper.current].score);//初始化页面分值
      } else if (res.code == 10029) {
        wx.setNavigationBarTitle({
          title: '待批阅： 0'
        })
        this.setData({
          page_title: '待批阅： 0',
          no_papar: false,
          'swiper.current': 0
        })
        return
      }
    })
  },
  mainHandle(res, flag, aid) {
    console.log(res)
    if (res.code == 10000) {
      if (!res.data) {
        wx.showToast({
          content: '没有更多试卷了',
          duration: 2000
        })
        return
      }
      largeTimes = 0;
      var swiper = this.data.swiper;
      var alldatas = this.data.alldatas, totalnum = this.data.totalnum;
      var picdata;
      var type = this.data.testType;
      var judgeAnswer = this.data.judgeAnswer;
      
      if (flag == 1) {
        if (res.data.type == 1 || res.data.type == 2) {
          type = 1;
          judgeAnswer = !this.data.transverse?true:false;
        } else if (res.data.type == 10) {
          type = 2 //多选题
        } else if (res.data.type == 3) {
          type = 3
        } else if (res.data.type == 4) {
          type = 4
        }
        picdata = res.data.TopicData;
        /*从最后一个开始*/
        // swiper.current = res.data.TopicData.length-1;
        swiper.allScore = res.data.score;
        swiper.answer = res.data.questionPic ? JSON.parse(res.data.questionPic) : [];
        swiper.standard = res.data.answer; //参考答案
        var answerArr = [];
        answerArr.push({
          value: '',
          allowValue: this.getNumber(res.data.score)
        })
        var arr = this.getNumber(res.data.score);
        this.computedKeycode(arr);
        this.setData({
          answerArr: answerArr
        })
        if(type != 1 && res.data.answer.length != 0){
          var answerImg = JSON.parse(res.data.answer) || [];
          swiper.answer_img = answerImg[0] ? answerImg[0].url : '';
        }
        var setrule = [];
        swiper.rule = res.data.rule?res.data.rule:[4,2,1,0]; //多选题规则
      } else { //------------------------
        picdata = res.data;
      }
      var oss_url = "";
      for (let j = 0; j < picdata.length; j++) {
        var item = picdata[j];
        var reg = new RegExp("\\\\","g");
        if(reg.test(item.answerPostion)){
          item.answerPostion = item.answerPostion.replace(reg, "");
          var start = item.answerPostion.indexOf("[");
          var end = item.answerPostion.indexOf("]");
          if(start != 0 || end != (item.answerPostion.length-1)){
            item.answerPostion = item.answerPostion.substring(start,end+1);
          }
        }
        item.answerPostion = item.answerPostion ? JSON.parse(item.answerPostion) : [];
        if (item.answerPostion.length > 0) {
          item.answerPostion = item.answerPostion.filter(item => {
            var pic_url = item.url;
            item.url = pic_url.substring(0, pic_url.indexOf('?') != -1 ? pic_url.indexOf('?') : 9999);
            var w = parseInt(item.width);
            var h = parseInt(item.height);
            var x = parseInt(item.positionX);
            var y = parseInt(item.positionY);
            if (pic_url.indexOf('?') != -1) {
              item.oss_url = pic_url.substring(pic_url.indexOf('?') + 1);
              oss_url = pic_url.substring(pic_url.indexOf('?') + 1);
            }
            if(oss_url == ''){
              oss_url += `x-oss-process=image/crop,x_${x},y_${y},h_${h},w_${w}`;
            }
            if (item.oss_url == '') {
              item.oss_url += `x-oss-process=image/crop,x_${x},y_${y},h_${h},w_${w}`
            }
            item.default_height = h;
            item.default_width = w;
            return item;
          })
        }
        if(reg.test(item.studentNamePic)){
          item.studentNamePic = item.studentNamePic.replace(reg, "");
          var start = item.studentNamePic.indexOf("[");
          var end = item.studentNamePic.indexOf("]");
          if(start != 0 || end != (item.studentNamePic.length-1)){
            item.studentNamePic = item.studentNamePic.substring(start,end+1);
            console.log(item.studentNamePic)
          }
        }
        item.studentNamePic = item.studentNamePic ? JSON.parse(item.studentNamePic) : [];
      }
      console.log(picdata)
      swiper.imgUrls = picdata;
      if(aid){
        var currentIndex = swiper.imgUrls.findIndex(item => item.id == aid);
        if(currentIndex != -1){
          swiper.current = currentIndex;
        }
      }
      /*装入已评卷数组 */
      var answerDatas = this.data.answerData;
      for (let i = 0; i < swiper.imgUrls.length; i++) {
        var obj = {};
        obj.id = swiper.imgUrls[i].id;
        obj.score = swiper.imgUrls[i].score;
        obj.symbolMark = swiper.imgUrls[i].symbolMark;
        // console.log('obj',obj)
        if (answerDatas.length > 0) {
          var result = answerDatas.findIndex(item => item.id == obj.id);
          // console.log('result',result)
          if (result >= 0) {
            answerDatas[result] = obj;
          } else {
            answerDatas.push(obj);
          }
        } else {
          answerDatas.push(obj);
        }
      }
      var keyrow = Math.ceil(res.data.score / 6);
      var unfinish = picdata.filter(item => {
        return item.score == null;
      })
      var curindex = 0;
      if(unfinish.length != 0){
        curindex = swiper.imgUrls.findIndex(item => item.id == unfinish[0].id);
      }
      swiper.current = curindex;
      var settitle = unfinish.length?'待批阅：' + unfinish.length:'回评卷';
      var curpage = this.data.curpage;

      if(res.data.check && res.data.markAll != res.data.check){
        curpage = Math.ceil((res.data.check + 1) / 10);
      }
      
      wx.setNavigationBarTitle({
        title: settitle
      })
      console.log('answerdata', answerDatas)
      this.setData({
        title: settitle,
        page_title: settitle,
        oss_url: oss_url,
        swiper: swiper,
        testType: type,
        coreCurrent: 0,
        answerData: answerDatas,
        judgeAnswer,
        no_papar: true,
        keyrows: keyrow,
        back: unfinish.length?false:true,
        curpage,
        alldatas
      })
      this.getPaperInfo(swiper.imgUrls[swiper.current].symbolMark);//初始化页面线条等
      this.getScore(swiper.imgUrls[swiper.current].score);//初始化页面分值
      //this.getNextImg();
    } else if (res.code == 10029) {
      var title = this.data.title,page_title = this.data.page_title;
      wx.setNavigationBarTitle({
        title: title == '待批阅' ? title + "： 0" : title
      })
      this.setData({
        page_title: page_title == '待批阅' ? page_title + "： 0" : page_title,
        no_papar: false,
        'swiper.current': 0
      })
    }
  },
  
  /*把当前已经评论的题块放进一个数组中*/
  pushAnswerData(data) {
    var obj = {};
    var answerDatas = this.data.answerData;
    obj.id = data.id;
    obj.score = data.score;
    obj.symbolMark = data.symbolMark;
    if (answerDatas.length > 0) {
      var result = answerDatas.findIndex(item => item.id == obj.id);
      if (result >= 0) {
        answerDatas[result] = obj;
      } else {
        answerDatas.push(obj);
      }
    } else {
      answerDatas.push(obj);
    }
    console.log('answerdata', answerDatas)
    this.setData({ //把答案分数，划线 文字等装进数组
      answerData: answerDatas
    })
  },
  //setPropAction
  setPropAction(e){
    var flag = e.currentTarget.dataset.flag;
    var rules = this.data.swiper.rule,chooseCode = [];
    flag = flag > 0;
    for(var i in rules){
      var rule = {};
      if(i == 0){
        rule.title = "漏选零项";
      }
      if(i == 1){
        rule.title = "漏选一项";
      }
      if(i == 2){
        rule.title = "漏选二项";
      }
      if(i == 3){
        rule.title = "漏选三项";
      }
      rule.idd = i;
      rule.num = rules[i];
      chooseCode.push(rule);
    }
    console.log(chooseCode)
    this.setData({
      set_flag: flag,
      chooseCode
    })
  },
  //获取各块宽高
  getVh(){
    return new Promise((response, reject) => {
      wx.getSystemInfo({
        success: (res) => {
          console.log(res)
          var transverse = res.screenWidth > res.screenHeight;
          this.setData({
            screenWidth: res.screenWidth,
            screenHeight: res.screenHeight,
            barHeight: res.statusBarHeight,
            transverse,
            judgeAnswer: transverse ? false : true,
            moreKeyCode: false
          })
          var query = wx.createSelectorQuery();
          query.select('.contain').boundingClientRect();
          //query.selectViewport().scrollOffset();
          query.exec((res) => {
            console.log(res)
            if (res[0]) {
              this.setData({
                vw: res[0].width,
                vh: res[0].height,
                boxTop: res[0].top,
                boxLeft: res[0].left,
              })
              response();
            }
          })
        }
      })
      /*进入页面时获取pic 元素的宽高，存下来备用*/
      
    })
  },
  //修改打分规则
  resetRules(e){
    var _this = this,_data = _this.data;
    var examId = _data.examId,questionId = _data.questionId
    var scores = _data.swiper.allScore,
      chooseCode = _data.chooseCode,
      rules = _data.swiper.rule;
    var rule1 = e.detail.value.rule1;
    var rule2 = e.detail.value.rule2;
    var rule3 = e.detail.value.rule3;
    var tip = '';
    if(rule1 == ''|| rule2 == ''|| rule3 == ''){
      tip = '请填完所有规则';
    }else if(rule1 > scores || rule2 > scores || rule3 > scores){
      tip = '分值不能大于题目总分';
    }else{
      tip = '规则设置成功';
    }
    if(tip != '规则设置成功'){
      wx.showToast({
        title: tip,
        icon: "none",
        duration: 1000
      });
      return false;
    }

    rules = {"0": rule1,"1": rule2,"2": rule3};
    if(!examId || !questionId || !rules) return false;
    console.log({
      examId: examId,
      questionId: questionId,
      rule: rules
    })
    updateRule({
      examId: examId,
      questionId: questionId,
      rule: rules
    }).then((res)=>{
      console.log(res)
      if(res.code == 10000){
        wx.showToast({
          title: '设置成功',
          success:()=>{
            _this.setData({
              'swiper.rule': rules,
              set_flag: false
            })
          }
        })
      }else{
        wx.showToast("设置成功");
      }
    }).catch(res => {
      wx.showToast({
        title: "请求出错,请返回重试",
        icon: "none"
      })
    })
  },
  //tabbar 操作的前进或撤销
  forwardHandle(e) {
    var forward = e.currentTarget.dataset.forward;
    var textMark = this.data.textMark;
    var lineMark = this.data.lineMark;
    //console.log(oldText,textArrays,oldLine,lineMark,lineArrays)
    var close = this.data.close;//是否划线
    var line = this.data.line;//是否备注
    if (!close) {
      if (lineArrays.length == 0) return false;
      if(forward == 1){//前进
        if (lineMark.length - oldLine == lineArrays.length) {
          wx.showToast({
            title: "已经是最新了",
            icon: "none"
          })
          return false
        };
        var cur = (lineArrays.slice(lineMark.length - oldLine,lineMark.length+1))[0];
        lineMark.push(cur)
      }else{//后退
        if (lineMark.length == oldLine) {
          wx.showToast({
            title: "没有了",
            icon: "none"
          })
          return false
        };
        lineMark.pop();
      }
    }
    if (!line) {
      if (textArrays.length == 0) return false;
      if(forward == 1){//前进
        if (textMark.length - oldText == textArrays.length) {
          wx.showToast({
            title: "已经是最新了",
            icon: "none"
          })
          return false
        };
        var cur = (textArrays.slice(textMark.length - oldLine,textMark.length+1))[0];
        textMark.push(cur)
      }else{//后退
        if (textMark.length == 0) {
          wx.showToast({
            title: "没有了",
            icon: "none"
          })
          return false
        };
        textMark.pop();
      }
    }
    this.setData({
      lineMark,
      textMark
    })
  },
  onResize(e){
    console.log("onResize")
    var screenWidth = this.data.screenWidth,enlargeY = this.data.enlargeY;
    this.setData({
      vh: 0,
      vw: 0
    })
    this.getVh().then(()=>{
      this.imgload(imgobj);
      this.computedKeycode(this.data.keyCode);
    })
  },
  errorFun(){
    wx.showToast({
      title: "请求出错,请返回重试",
      icon: "none"
    })
    var timer1 = setTimeout(() => {
      wx.navigateBack({
        delta: 1
      })
      clearTimeout(timer1);
    }, 1500)
  }
});
